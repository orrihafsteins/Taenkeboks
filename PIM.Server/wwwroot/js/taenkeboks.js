var visible = { "playerNames": ["orrihafsteins@gmail.com", "Bob", "Alice", "Carol"], "spec": { "playerCount": 4, "ofAnyKind": false, "diceCount": 4, "multiSeries": false, "oneIsSeries": true, "extraLives": 1, "lastStanding": true }, "nextSide": 0, "diceLeft": [4, 4, 4, 4], "livesLeft": [2, 2, 2, 2], "playerCount": 4, "totalDiceLeft": 16, "madeBetSide": 3, "currentBet": { "count": 1, "value": 2 }, "playersLeft": 4, "viewingSide": 0, "legalActions": [{ "call": true, "bet": { "count": 0, "value": 6 } }, { "call": false, "bet": { "count": 1, "value": 3 } }, { "call": false, "bet": { "count": 1, "value": 4 } }, { "call": false, "bet": { "count": 1, "value": 5 } }, { "call": false, "bet": { "count": 1, "value": 6 } }, { "call": false, "bet": { "count": 2, "value": 2 } }, { "call": false, "bet": { "count": 2, "value": 3 } }, { "call": false, "bet": { "count": 2, "value": 4 } }, { "call": false, "bet": { "count": 2, "value": 5 } }, { "call": false, "bet": { "count": 2, "value": 6 } }, { "call": false, "bet": { "count": 3, "value": 2 } }, { "call": false, "bet": { "count": 3, "value": 3 } }, { "call": false, "bet": { "count": 3, "value": 4 } }, { "call": false, "bet": { "count": 3, "value": 5 } }, { "call": false, "bet": { "count": 3, "value": 6 } }, { "call": false, "bet": { "count": 4, "value": 2 } }, { "call": false, "bet": { "count": 4, "value": 3 } }, { "call": false, "bet": { "count": 4, "value": 4 } }, { "call": false, "bet": { "count": 4, "value": 5 } }, { "call": false, "bet": { "count": 4, "value": 6 } }, { "call": false, "bet": { "count": 5, "value": 2 } }, { "call": false, "bet": { "count": 5, "value": 3 } }, { "call": false, "bet": { "count": 5, "value": 4 } }, { "call": false, "bet": { "count": 5, "value": 5 } }, { "call": false, "bet": { "count": 5, "value": 6 } }, { "call": false, "bet": { "count": 6, "value": 2 } }, { "call": false, "bet": { "count": 6, "value": 3 } }, { "call": false, "bet": { "count": 6, "value": 4 } }, { "call": false, "bet": { "count": 6, "value": 5 } }, { "call": false, "bet": { "count": 6, "value": 6 } }, { "call": false, "bet": { "count": 7, "value": 2 } }, { "call": false, "bet": { "count": 7, "value": 3 } }, { "call": false, "bet": { "count": 7, "value": 4 } }, { "call": false, "bet": { "count": 7, "value": 5 } }, { "call": false, "bet": { "count": 7, "value": 6 } }, { "call": false, "bet": { "count": 8, "value": 2 } }, { "call": false, "bet": { "count": 8, "value": 3 } }, { "call": false, "bet": { "count": 8, "value": 4 } }, { "call": false, "bet": { "count": 8, "value": 5 } }, { "call": false, "bet": { "count": 8, "value": 6 } }, { "call": false, "bet": { "count": 9, "value": 2 } }, { "call": false, "bet": { "count": 9, "value": 3 } }, { "call": false, "bet": { "count": 9, "value": 4 } }, { "call": false, "bet": { "count": 9, "value": 5 } }, { "call": false, "bet": { "count": 9, "value": 6 } }, { "call": false, "bet": { "count": 10, "value": 2 } }, { "call": false, "bet": { "count": 10, "value": 3 } }, { "call": false, "bet": { "count": 10, "value": 4 } }, { "call": false, "bet": { "count": 10, "value": 5 } }, { "call": false, "bet": { "count": 10, "value": 6 } }, { "call": false, "bet": { "count": 11, "value": 2 } }, { "call": false, "bet": { "count": 11, "value": 3 } }, { "call": false, "bet": { "count": 11, "value": 4 } }, { "call": false, "bet": { "count": 11, "value": 5 } }, { "call": false, "bet": { "count": 11, "value": 6 } }, { "call": false, "bet": { "count": 12, "value": 2 } }, { "call": false, "bet": { "count": 12, "value": 3 } }, { "call": false, "bet": { "count": 12, "value": 4 } }, { "call": false, "bet": { "count": 12, "value": 5 } }, { "call": false, "bet": { "count": 12, "value": 6 } }, { "call": false, "bet": { "count": 13, "value": 2 } }, { "call": false, "bet": { "count": 13, "value": 3 } }, { "call": false, "bet": { "count": 13, "value": 4 } }, { "call": false, "bet": { "count": 13, "value": 5 } }, { "call": false, "bet": { "count": 13, "value": 6 } }, { "call": false, "bet": { "count": 14, "value": 2 } }, { "call": false, "bet": { "count": 14, "value": 3 } }, { "call": false, "bet": { "count": 14, "value": 4 } }, { "call": false, "bet": { "count": 14, "value": 5 } }, { "call": false, "bet": { "count": 14, "value": 6 } }, { "call": false, "bet": { "count": 15, "value": 2 } }, { "call": false, "bet": { "count": 15, "value": 3 } }, { "call": false, "bet": { "count": 15, "value": 4 } }, { "call": false, "bet": { "count": 15, "value": 5 } }, { "call": false, "bet": { "count": 15, "value": 6 } }, { "call": false, "bet": { "count": 16, "value": 2 } }, { "call": false, "bet": { "count": 16, "value": 3 } }, { "call": false, "bet": { "count": 16, "value": 4 } }, { "call": false, "bet": { "count": 16, "value": 5 } }, { "call": false, "bet": { "count": 16, "value": 6 } }, { "call": false, "bet": { "count": 17, "value": 2 } }, { "call": false, "bet": { "count": 17, "value": 3 } }, { "call": false, "bet": { "count": 17, "value": 4 } }, { "call": false, "bet": { "count": 17, "value": 5 } }, { "call": false, "bet": { "count": 17, "value": 6 } }, { "call": false, "bet": { "count": 18, "value": 2 } }, { "call": false, "bet": { "count": 18, "value": 3 } }, { "call": false, "bet": { "count": 18, "value": 4 } }, { "call": false, "bet": { "count": 18, "value": 5 } }, { "call": false, "bet": { "count": 18, "value": 6 } }, { "call": false, "bet": { "count": 19, "value": 2 } }, { "call": false, "bet": { "count": 19, "value": 3 } }, { "call": false, "bet": { "count": 19, "value": 4 } }, { "call": false, "bet": { "count": 19, "value": 5 } }, { "call": false, "bet": { "count": 19, "value": 6 } }, { "call": false, "bet": { "count": 20, "value": 2 } }, { "call": false, "bet": { "count": 20, "value": 3 } }, { "call": false, "bet": { "count": 20, "value": 4 } }, { "call": false, "bet": { "count": 20, "value": 5 } }, { "call": false, "bet": { "count": 20, "value": 6 } }], "actionHistory": [{ "time": "2020-04-21T22:17:48.474174+02:00", "side": 3, "action": { "call": true, "bet": { "count": 1, "value": 2 } } }], "status": { "inPlay": true, "loser": -1, "winner": -1 }, "playerHand": [1, 1, 2, 6], "playerMessage": "Carolraised1d2", "roundReport": { "playerMadeBet": -1, "playerCalledBet": -1, "playerLost": -1, "playerDice": [], "playerContribution": [], "betCalled": { "count": 0, "value": 6 }, "betHighestStanding": { "count": 0, "value": 6 } }, "gameReport": { "playerLost": -1 }, "tournamentReport": { "playerWon": -1, "playerLost": -1 } }
var gameID = "TestGameID"
$(document).ready(function () {
    nextBoard(gameID);
});

lastRefreshed = -1 //TODO: Get rid of this
function nextBoard(gameID) {
    $.getJSON("/game/taenkeboks/play/" + gameID +"/current",
        function (v) {
            currentMove = v.actionHistory.length
            if (currentMove > lastRefreshed) {
                lastRefreshed = currentMove
                if (!v.status.inPlay) {
                    render(v)
                    //renderLifeResult(b.status, b, gameID, null)
                }
                else
                    render(v)
            }
        })
        .fail(
            function (jqXHR, textStatus, err) {
                $("#dump").text(err)
            });
}

function render(v) {
    $("#dump").empty().append(JSON.stringify(v, undefined, 2))
    renderPlayers(v)
    $("#choppingBlock").html(v.totalDiceLeft + " dice in play")
    $("#currentBet").html(printBet(v.currentBet))
    $("#nextPlayerText").empty()
    hideMoves()
    if (v.nextSide === v.viewingSide) {
        showMoves(v.legalActions, gameID)
    }
    else {
        $("#nextPlayerText").text(playerNames[nextPlayer] + " to move")
    }
}

function hideMoves() {
    $("#callSpan").hide()
    $("#raiseSpan").hide()
    $("#continueButton").hide()
    $("#restartButton").hide()
}

function showMoves(legalMoves) {
    //call button
    if (legalMoves[0].call) {
        $("#callSpan").show()
        $("#callButton").off().click(function () {
            //window.alert("click");
            //alert($('#moves').val())
            $.ajax({
                type: 'POST',
                accepts: 'application/json',
                url: "/game/taenkeboks/play/" + gameID +"/action",
                contentType: 'application/json',
                data: JSON.stringify(legalMoves[0]),
                error: function (jqXHR, textStatus, errorThrown) {
                    alert("error performing move: " + errorThrown);
                },
                success: function (result) {
                    //efreshBoard();
                }
            });
        });
    }
    //numbers
    var raises = legalMoves.filter(a => !a.call)
    var nextRaise = raises[0]
    var counts = Array.from(new Set(raises.map(a => a.bet.count)))
    var fValues = function (count) {
        var countBet = raises.filter(a => a.bet.count == count)
        var countValues = countBet.map(a => a.bet.value)
        return countValues
    }
    //counts
    var countDropdown = $("#raiseCounts")
    countDropdown.empty()
    for (var val in counts) {
        $('<option />', { value: counts[val], text: counts[val] }).appendTo(countDropdown);
    }

    //values
    var valueDropdown = $("#raiseValues")
    var setValues = function (count, selected) {
        var lastValue = valueDropdown.val()
        valueDropdown.empty()
        values = fValues(count)
        for (var val in values) {
            $('<option />', { value: values[val], text: values[val] }).appendTo(valueDropdown);
        }
        if (lastValue)
            if (values.includes(parseInt(lastValue)))
                valueDropdown.val(lastValue)
    }
    setValues(nextRaise.bet.count)
    countDropdown.off().change(function () {
        setValues(countDropdown.val())
    })
    //raise button
    $("#raiseSpan").show()
    $("#raiseButton").off().click(function () {
        //window.alert("click");
        //alert($('#moves').val())
        var bet = {
            "call": false,
            "bet": {
                "count": countDropdown.val(),
                "value": valueDropdown.val()
            }
        }
        $.ajax({
            type: 'POST',
            accepts: 'application/json',
            url: "/game/taenkeboks/play/" + gameID + "/action",
            contentType: 'application/json',
            data: JSON.stringify(bet),
            error: function (jqXHR, textStatus, errorThrown) {
                alert("error performing move: " + errorThrown);
            },
            success: function (result) {
                //refreshBoard();
            }
        });
    });
}

function printBet(b) {
    if (b.count === 0) return "round start"
    return printDiceCount(b)
}

function printDiceCount(b) {
    var valueString = die(b.value)
    var countString = String(b.count)
    return countString + " " + valueString
}

function die(value) {
    if (value > 0)
        return '<img class="die" src="/images/Dice' + value + '.gif"/>'
    else if (value === 0)
        return '<img class="die" src="/images/DiceAny.gif" />'
}

function renderPlayers(v) {
    $("#playerRow").empty()
    for (i = 1; i < v.playerCount; i++) {
        var side = (v.viewingSide + i) % v.playerCount
        $("#playerRow").append(renderPlayerCell(v, side))
    }
    $("#selfRow").empty().append(renderPlayerCell(v, v.viewingSide).attr('colspan', v.playerCount - 1));
}

function renderPlayerCell(v, side) {
    var diceLeft = v.diceLeft[side]
    var playerName = v.playerNames[side]
    var livesLeft = v.livesLeft[side]
    var lastBet = '&nbsp;'
    for (var i = 0; i < v.actionHistory.length; i++) {
        if (v.actionHistory[i].action.call) break;
        if (v.actionHistory[i + 1].side === side) {
            lastBet = printAction(v.actionHistory[i].action)
            break;
        }
    }
    var playerCell = $('<td id=\"' + side + '\" class="player">')
    if (livesLeft === 0) {
        playerCell = $('<td id=\"' + side + '\" class="player deadPlayer">')
        playerCell.append('<div class="playerName">' + playerName + '</div>')
    }
    else if (livesLeft === 1)
        playerCell.append('<div class="playerName">' + playerName + '</div>')
    else
        playerCell.append('<span class="playerName">' + playerName + '<span class="playerLives">&nbsp;x' + livesLeft + '</span></span>')

    playerCell.append('<div id=\"bet' + side + '\" class="playerBet">' + lastBet + '<div>')
    //var diceTable = $('<table class="dieTable"></table>')
    var hand;
    //diceRow.appendTo(diceTable)

    var handElement = $('<div id=\"hand' + side + '\">')
    if (side === v.viewingSide) {
        hand = v.playerHand
    }
    else {
        hand = Array.apply(null, Array(diceLeft)).map(Number.prototype.valueOf, 0);
    }
    populateHand(hand, handElement)
    playerCell.append(handElement)
    if (v.nextPlayer === side)
        playerCell.addClass('active')
    return playerCell
}

function populateHand(hand, handElement) {
    handElement.empty()
    for (var di = 0; di < hand.length; di++)
        handElement.append($(die(hand[di])))
}

function printAction(a) {
    if (a.call) {
        return " call"
    }
    else {
        return printBet(a.bet)
    }
}